# プレイヤーデータ収集システムの説明

## 「切断」とは？

### 日本語での意味
**切断 (せつだん)** = **Disconnect** = プレイヤーがMinecraftサーバーからログアウト/退出すること

### 具体的な流れ

#### 1. プレイヤーがログイン（接続）
```
[2025-10-28 22:30:14] Player connected: mon8 kk, xuid: 253540638722448
                      ^^^^^^^^^^^^^^^^
                      「プレイヤーが接続しました」
```

**この時**:
- データコレクターがこのメッセージを検出
- セッション開始時刻を記録
- データベースにセッションを保存

#### 2. プレイヤーがプレイ中
- プレイヤーはMinecraftでゲームをプレイ
- データコレクターは60秒ごとに「まだオンラインか」を確認

#### 3. プレイヤーがログアウト（切断）
```
[2025-10-28 20:38:55] Player disconnected: masin670310, xuid: 25354357
                      ^^^^^^^^^^^^^^^^^^^^
                      「プレイヤーが切断しました」
```

**この時**:
- データコレクターがこのメッセージを検出
- セッション終了時刻を記録
- プレイ時間を計算: 終了時刻 - 開始時刻
- データベースのtotal_playtimeに追加
- ランキングが更新される

## 現在の状況

### オンライン中のプレイヤー
```
✅ mon8 kk
   - 接続時刻: 2025-10-28 22:30:14
   - 状態: まだオンライン（プレイ中）
   - セッション: 記録中
```

### 過去にログアウトしたプレイヤー
```
✅ masin670310
   - 最後の接続: 2025-10-28 20:39:40
   - 最後の切断: 2025-10-28 21:26:33
   - プレイ時間: 約47分

✅ MiraTM3409
   - 最後の接続: 2025-10-28 21:53:59
   - 最後の切断: 2025-10-28 22:16:57
   - プレイ時間: 約23分
```

## なぜ「切断」が重要か？

### プレイ時間の計算
```
プレイ時間 = 切断時刻 - 接続時刻
```

**例**:
```
接続: 14:00:00
切断: 15:30:00
プレイ時間: 1時間30分
```

### ランキングへの反映
1. プレイヤーがログイン → セッション開始
2. プレイヤーがログアウト → セッション終了 + プレイ時間計算
3. データベース更新 → ランキングに反映

## データコレクターの動作

### 現在の問題
```
📊 Current Rankings:
(空)
```

これは**正常**です。なぜなら:
- データコレクターは2025-10-28 14:02頃に起動
- しかし過去のプレイヤー（masin670310, MiraTM3409）のセッションは
  データコレクター起動前に終了していた
- mon8 kkはまだオンライン中

### 解決方法

#### 方法1: mon8 kkさんがログアウトするのを待つ
- mon8 kkさんがMinecraftからログアウト
- データコレクターが「Player disconnected: mon8 kk」を検出
- プレイ時間を計算してデータベースに保存
- ランキングに表示される

#### 方法2: 過去のログを解析して履歴データを追加
過去のセッションを再計算するスクリプトを作成できます。

## 実装の確認

### ログの確認方法
```bash
# Minecraftサーバーのログを確認
cd /home/kbt0/webapp/minecraft-site
screen -S tama -X hardcopy /tmp/screen-tama.log
cat /tmp/screen-tama.log | tail -50
```

### データコレクターの動作確認
```bash
# データコレクターのログを確認
tail -f /home/kbt0/webapp/minecraft-site/player-data-collector.log
```

**期待される出力**:
```
🔄 Collecting player data...
👥 Online players: 1
   Players: mon8 kk
```

### プレイヤーがログアウトした時の動作
```
🔄 Collecting player data...
👥 Online players: 0
✅ Session ended for mon8 kk (45m 30s)

📊 Current Rankings:
   1. mon8 kk: 45m 30s
```

## まとめ

- **接続 (connected)** = プレイヤーがログイン
- **切断 (disconnected)** = プレイヤーがログアウト
- **プレイ時間** = 切断時刻 - 接続時刻
- **ランキング反映** = プレイヤーが切断した時に更新

現在mon8 kkさんがプレイ中なので、ログアウトすればランキングに表示されます！
