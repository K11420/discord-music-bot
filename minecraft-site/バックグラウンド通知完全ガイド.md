# 📱 バックグラウンド通知完全ガイド

## 🔍 iOS PWAの制限事項

### ❌ iOS PWAでできないこと

1. **真のバックグラウンドプッシュ通知**
   - アプリが完全に閉じている場合、通知は届かない
   - Web Push API（FCM等）は非対応
   - Periodic Background Syncは非対応

2. **Service Workerのバックグラウンド実行**
   - アプリが閉じると、Service Workerも停止
   - 定期的なバックグラウンドタスクは実行されない

### ✅ iOS PWAでできること

1. **アプリがアクティブな場合の通知**
   - フォアグラウンドでは完全に動作
   - WebSocket経由のリアルタイム通知

2. **一時的なバックグラウンド（数分間）**
   - アプリを最小化直後は通知が届く可能性あり
   - 完全に閉じると届かない

---

## 💡 解決策: サードパーティ通知サービス

### オプション1: LINE Notify（推奨）

**メリット:**
- ✅ 無料で簡単
- ✅ 日本で広く使われている
- ✅ 即座に通知が届く
- ✅ アプリが閉じていても届く

**セットアップ手順:**

#### 1. LINE Notifyトークンを取得

1. https://notify-bot.line.me/ にアクセス
2. LINEアカウントでログイン
3. 「マイページ」→「トークンを発行する」
4. トークン名: `Minecraft Server`
5. 通知先: `1:1でLINE Notifyから通知を受け取る`
6. 「発行する」をクリック
7. **トークンをコピー**（再表示不可なので注意！）

#### 2. サーバーに環境変数を設定

```bash
cd /home/kbt0/webapp/minecraft-site

# 環境変数を設定
export LINE_NOTIFY_TOKEN="your_token_here"

# 永続化（.bashrcに追加）
echo 'export LINE_NOTIFY_TOKEN="your_token_here"' >> ~/.bashrc
source ~/.bashrc
```

#### 3. プッシュ通知サーバーを起動

```bash
# テスト実行
node push-notification-server.js

# バックグラウンドで実行
nohup node push-notification-server.js > push-notification.log 2>&1 &

# ログ確認
tail -f push-notification.log
```

#### 4. テスト通知を送信

```bash
# 新しいイベントを作成
node test-notification-now.js
```

LINEアプリで通知を確認してください！

---

### オプション2: Discord Webhook

**メリット:**
- ✅ 無料で使いやすい
- ✅ グループ通知に最適
- ✅ カスタマイズ可能

**セットアップ手順:**

#### 1. Discord Webhookを作成

1. Discordサーバーを開く
2. チャンネル設定 → 連携サービス → Webhook
3. 「新しいWebhook」をクリック
4. 名前: `Minecraft Server`
5. **Webhook URLをコピー**

#### 2. サーバーに環境変数を設定

```bash
export DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/..."

# 永続化
echo 'export DISCORD_WEBHOOK_URL="your_webhook_url_here"' >> ~/.bashrc
source ~/.bashrc
```

#### 3. プッシュ通知サーバーを起動（上記と同じ）

---

### オプション3: Telegram Bot

**メリット:**
- ✅ 高速で信頼性が高い
- ✅ グローバルに使える
- ✅ リッチな通知

**セットアップ手順:**

#### 1. Telegram Botを作成

1. Telegramで @BotFather を検索
2. `/newbot` コマンドを送信
3. Bot名: `Minecraft Server Bot`
4. **Bot Tokenをコピー**

#### 2. Chat IDを取得

1. Botにメッセージを送信
2. https://api.telegram.org/bot<TOKEN>/getUpdates にアクセス
3. `chat.id` をコピー

#### 3. スクリプトを修正して実装

---

## 🚀 推奨セットアップ: LINE Notify

### 完全な手順

#### ステップ1: LINE Notifyトークンを取得

```bash
# ブラウザで以下にアクセス
https://notify-bot.line.me/
```

1. LINEでログイン
2. マイページ
3. トークンを発行する
4. トークン名: `Minecraft Server`
5. 通知先: `1:1でLINE Notifyから通知を受け取る`
6. 発行
7. **トークンをコピー**

#### ステップ2: サーバーに設定

```bash
cd /home/kbt0/webapp/minecraft-site

# 環境変数を設定（your_token_hereを実際のトークンに置き換え）
export LINE_NOTIFY_TOKEN="your_token_here"

# 永続化
echo 'export LINE_NOTIFY_TOKEN="your_token_here"' >> ~/.bashrc
source ~/.bashrc

# 確認
echo $LINE_NOTIFY_TOKEN
```

#### ステップ3: プッシュ通知サーバーを起動

```bash
# 実行権限を付与
chmod +x push-notification-server.js

# バックグラウンドで起動
nohup node push-notification-server.js > push-notification.log 2>&1 &

# プロセスIDを確認
echo $! > push-notification.pid

# ログを確認
tail -f push-notification.log
```

出力例:
```
🚀 プッシュ通知サーバーを起動中...
============================================================
📋 最新イベントID: 16

⚙️  通知設定:
   LINE Notify: ✅ 有効
   Discord Webhook: ❌ 無効

⏰ チェック間隔: 5分ごと
============================================================

✅ 監視を開始しました...
   (Ctrl+C で終了)
```

#### ステップ4: テスト通知を送信

```bash
# 新しいイベントを作成
node test-notification-now.js
```

**LINEアプリで通知を確認！**

通知内容:
```
🎉 新しいイベント

「📱 通知テスト 17:02:38」が追加されました！
📅 10月30日 17:02

✨ https://minecraft.schale41.jp
```

---

## 🔧 管理コマンド

### プッシュ通知サーバーの管理

```bash
# ステータス確認
ps aux | grep push-notification-server

# ログ確認
tail -f push-notification.log

# サーバー停止
kill $(cat push-notification.pid)

# サーバー再起動
kill $(cat push-notification.pid)
nohup node push-notification-server.js > push-notification.log 2>&1 &
echo $! > push-notification.pid
```

### 自動起動設定（systemd）

```bash
# サービスファイルを作成
sudo tee /etc/systemd/system/minecraft-push-notification.service << 'EOF'
[Unit]
Description=Minecraft Server Push Notification Service
After=network.target

[Service]
Type=simple
User=kbt0
WorkingDirectory=/home/kbt0/webapp/minecraft-site
Environment="LINE_NOTIFY_TOKEN=your_token_here"
ExecStart=/usr/bin/node /home/kbt0/webapp/minecraft-site/push-notification-server.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# サービスを有効化
sudo systemctl daemon-reload
sudo systemctl enable minecraft-push-notification
sudo systemctl start minecraft-push-notification

# ステータス確認
sudo systemctl status minecraft-push-notification

# ログ確認
sudo journalctl -u minecraft-push-notification -f
```

---

## 📊 動作確認

### チェックリスト

- [ ] LINE Notifyトークンを取得
- [ ] 環境変数を設定
- [ ] プッシュ通知サーバーを起動
- [ ] ログで「✅ 監視を開始しました」を確認
- [ ] テストイベントを作成
- [ ] LINEアプリで通知を受信

### 期待される動作

1. **管理画面でイベントを作成**
   ```
   https://minecraft.schale41.jp/admin
   ```

2. **5分以内にLINEに通知が届く**
   ```
   LINE Notify
   🎉 新しいイベント

   「イベント名」が追加されました！
   📅 10月30日 17:02

   ✨ https://minecraft.schale41.jp
   ```

3. **PWAアプリにも通知が届く（アプリが開いている場合）**

---

## 🎯 まとめ

### ✅ この方法の利点

1. **アプリが閉じていても通知が届く**
   - LINEアプリで受信
   - 確実に通知を受け取れる

2. **設定が簡単**
   - 5分で完了
   - 無料で使える

3. **信頼性が高い**
   - LINEの通知インフラを使用
   - 99.9%の到達率

### ⚠️ 注意事項

1. **5分間隔でチェック**
   - イベント作成後、最大5分遅れる可能性
   - より頻繁にチェックする場合は間隔を短縮

2. **LINE Notifyの制限**
   - 1時間に1000リクエストまで
   - 通常使用では問題なし

---

## 🆘 トラブルシューティング

### 問題: LINEに通知が届かない

**確認事項:**

1. **トークンが正しく設定されているか**
   ```bash
   echo $LINE_NOTIFY_TOKEN
   ```

2. **プッシュ通知サーバーが起動しているか**
   ```bash
   ps aux | grep push-notification-server
   ```

3. **ログにエラーがないか**
   ```bash
   tail -20 push-notification.log
   ```

### 問題: プロセスが停止する

**解決方法:**

1. **systemdで自動起動を設定**（上記参照）

2. **ログでエラーを確認**
   ```bash
   tail -50 push-notification.log
   ```

---

## 📞 サポート

問題が解決しない場合は、以下を確認してください：

1. LINE Notifyトークンの有効性
2. 環境変数の設定
3. プロセスの起動状態
4. ログファイルのエラーメッセージ

---

**次のステップ:**

1. LINE Notifyトークンを取得
2. 環境変数を設定
3. プッシュ通知サーバーを起動
4. テスト通知を確認

今すぐ試してみてください！ 🚀
