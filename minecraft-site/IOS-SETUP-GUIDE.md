# 📱 iPhone/iPad PWA通知セットアップガイド

## 🎯 目的

このガイドでは、iPhone/iPadでMinecraftサーバーのPWAアプリをインストールし、イベント通知を受け取る方法を説明します。

---

## ⚠️ 重要：始める前に

### iOS通知の制限

- **iOS 16.4以降が必要**: それ以前のバージョンでは通知が動作しません
- **ホーム画面に追加が必須**: Safariブラウザでは通知は受け取れません
- **アプリがアクティブな時のみ**: バックグラウンドでは通知が制限されます
- **Safari専用**: Chrome/Firefoxアプリでは動作しません

### 確認事項

✅ iOSバージョンが16.4以上であること  
✅ Safariアプリを使用していること  
✅ Wi-Fiまたはモバイルデータ通信が有効であること

---

## 📝 セットアップ手順（5分）

### ステップ1: Safariでサイトにアクセス

1. **iPhone/iPadでSafariアプリを起動**

2. **以下のURLにアクセス:**
   ```
   https://minecraft.schale41.jp
   ```

3. **ページが完全に読み込まれるまで待つ**
   - サーバー状態が表示される
   - イベント情報が表示される

### ステップ2: ホーム画面に追加

1. **画面下部の「共有」ボタンをタップ**
   - 中央下部にある □ に ↑ のアイコン
   - または、アドレスバーの左側にある「ぁあ」をタップ

2. **メニューから「ホーム画面に追加」を探してタップ**
   - 下にスクロールして探す必要がある場合があります

3. **アプリ名を確認**
   - デフォルト: 「Bedrock」
   - 変更したい場合は編集可能

4. **右上の「追加」をタップ**

5. **ホーム画面にアイコンが追加されたことを確認**
   - Minecraftサーバーのアイコン
   - 名前: 「Bedrock」

### ステップ3: PWAアプリを起動

1. **ホーム画面から「Bedrock」アイコンをタップ**
   - 通常のアプリのように全画面で起動します
   - SafariのURLバーは表示されません

2. **アプリが完全に読み込まれるまで待つ**
   - 約2-3秒

### ステップ4: 通知を許可

アプリを起動すると、自動的に以下の流れで進みます：

1. **Service Workerが自動登録される（即座）**
   ```
   バックグラウンドで処理中...
   ```

2. **3秒後に通知許可のポップアップが表示される**
   ```
   「minecraft.schale41.jp」は通知を
   送信します。よろしいですか？

   [許可しない]  [許可]
   ```

3. **「許可」をタップ** ⚠️ 重要！

4. **ウェルカム通知が表示される**
   ```
   🎉 通知が有効になりました
   イベントが作成されると通知が届きます
   ```

### ステップ5: 動作確認

**ウェルカム通知が表示されればセットアップ完了です！**

✅ **成功の確認:**
- 通知バナーが画面上部に表示された
- 通知音が鳴った（マナーモードでない場合）
- 通知センターに履歴が残っている

---

## 🧪 通知テスト

実際にイベント通知をテストしてみましょう。

### 方法1: PCから管理画面でイベントを作成

1. **PCのブラウザで管理画面にアクセス:**
   ```
   https://minecraft.schale41.jp/admin
   ```

2. **ログイン:**
   - ユーザー名: `admin`
   - パスワード: `admin123`

3. **「新規イベント作成」をクリック**

4. **イベント情報を入力:**
   - タイトル: `テスト通知`
   - 日付: 今日の日付を選択
   - 時刻: 現在時刻より後を選択

5. **「作成」をクリック**

6. **iPhoneで通知を確認:**
   - 画面上部に通知バナーが表示される
   - タイトル: 🎉 新しいイベント
   - 本文: 「テスト通知」が追加されました！

### 方法2: 自動テスト（管理者向け）

サーバー側で以下のコマンドを実行：

```bash
cd /home/kbt0/webapp/minecraft-site
node test-ios-notification.js
```

実行後、iPhoneで通知を確認してください。

---

## 📊 期待される動作

### ✅ 正常に動作している場合

1. **アプリ起動時:**
   - 通知許可のポップアップが表示される
   - 「許可」をタップするとウェルカム通知が届く

2. **イベント作成時:**
   - **アプリがアクティブな場合:** 即座に通知バナーが表示される
   - **アプリが最小化されている場合:** 通知センターに追加される
   - **アプリが完全に閉じている場合:** 通知は届かない（iOS制限）

3. **通知の内容:**
   - タイトル: 🎉 新しいイベント
   - 本文: イベント名と日時
   - アイコン: Minecraftサーバーのアイコン

4. **通知をタップすると:**
   - アプリが開く
   - 管理画面にリダイレクトされる（設定による）

---

## ❌ トラブルシューティング

### 問題1: 通知許可のポップアップが表示されない

**考えられる原因:**
- Safariブラウザで開いている（PWAではない）
- すでに「許可しない」を選択した
- iOS 16.4未満のバージョン

**解決方法:**

```
1. ホーム画面の「Bedrock」アイコンから起動していることを確認
2. もし問題が続く場合:
   - ホーム画面の「Bedrock」アイコンを長押し
   - 「Appを削除」をタップ
   - Safari設定をリセット:
     設定 → Safari → 詳細 → Webサイトデータ
     → minecraft.schale41.jp を探して削除
   - 再度ステップ1から実行
```

### 問題2: 通知が届かない

**考えられる原因:**
- 通知許可が「拒否」になっている
- iOS通知設定がオフ
- アプリが完全に閉じている（iOS制限）
- WebSocket接続が切れている

**解決方法:**

```
1. iOS設定を確認:
   設定 → 通知 → Safari → 通知を許可 がオンか確認

2. アプリを再起動:
   - アプリを完全に閉じる（画面下から上にスワイプ）
   - ホーム画面から再度起動

3. 通知許可を再設定:
   - 設定 → Safari → 通知
   - minecraft.schale41.jp の通知を「許可」に変更

4. インターネット接続を確認:
   - Wi-Fiまたはモバイルデータが有効か確認
```

### 問題3: ウェルカム通知は届いたがイベント通知が届かない

**考えられる原因:**
- アプリがバックグラウンドまたは閉じている
- WebSocket接続が切断された

**解決方法:**

```
1. アプリをアクティブにする:
   - ホーム画面から「Bedrock」アプリを開く
   - アプリがアクティブな状態で通知テストを実行

2. アプリを再起動:
   - 完全に閉じてから再度開く

3. サーバー接続を確認:
   - アプリ内でサーバー状態が「オンライン」になっているか確認
```

### 問題4: 通知音が鳴らない

**考えられる原因:**
- iPhoneがマナーモード
- 通知音設定がオフ
- おやすみモード/集中モードが有効

**解決方法:**

```
1. マナーモードを確認:
   - iPhone側面のスイッチを確認
   - オレンジ色が見えていればマナーモード

2. 通知音設定を確認:
   設定 → サウンドと触覚 → 通知音 がオンか確認

3. 集中モードを確認:
   設定 → 集中モード → すべてオフにする
```

---

## 🔍 詳細デバッグ（上級者向け）

### Mac + iPhoneでコンソールログを確認

1. **準備:**
   - Lightning/USBケーブルでiPhoneとMacを接続
   - iPhone側で「このコンピュータを信頼」をタップ

2. **Mac Safariで開発メニューを有効化:**
   - Safari → 環境設定 → 詳細
   - 「メニューバーに"開発"メニューを表示」にチェック

3. **Webインスペクタを開く:**
   - Safari → 開発 → [iPhoneの名前]
   - minecraft.schale41.jp を選択

4. **コンソールタブで確認:**
   ```javascript
   // Service Worker状態を確認
   navigator.serviceWorker.getRegistration().then(reg => {
       console.log('Service Worker:', reg);
   });
   
   // 通知許可状態を確認
   console.log('Notification permission:', Notification.permission);
   
   // WebSocket接続状態を確認
   console.log('WebSocket:', ws);
   ```

5. **期待されるログ:**
   ```
   ✅ Service Worker registered: /
   ✅ Notification permission granted
   🎉 通知が有効になりました
   ```

---

## 📋 チェックリスト

セットアップ完了の確認に使用してください：

```
□ iOS 16.4以降のデバイスを使用
□ SafariでHTTPS://minecraft.schale41.jpにアクセス
□ ホーム画面に「Bedrock」アイコンを追加
□ ホーム画面からアプリを起動
□ 通知許可のポップアップで「許可」をタップ
□ ウェルカム通知が表示された
□ テストイベントを作成して通知が届いた
□ 通知音が鳴った（マナーモードでない場合）
□ 通知をタップしてアプリが開いた
```

---

## 💡 ヒントとコツ

### より良い通知体験のために

1. **アプリをDockに追加:**
   - よく使うアプリとして、Dockに配置すると便利

2. **通知設定をカスタマイズ:**
   - 設定 → 通知 → Safari → minecraft.schale41.jp
   - バナースタイル、サウンド、バッジなどを調整

3. **アプリをバックグラウンドで保持:**
   - アプリを完全に閉じずに、ホームボタンで戻る
   - マルチタスク画面でアプリを保持しておく

4. **定期的にアプリを開く:**
   - iOSの制限により、定期的にアプリを開くことで
     WebSocket接続を維持できます

---

## 🆘 サポート

問題が解決しない場合:

1. **ログを確認:**
   - Mac + iPhone でWebインスペクタを使用
   - コンソールログでエラーを確認

2. **サーバー管理者に連絡:**
   - サーバー側のログを確認してもらう
   - WebSocket接続の状態を確認してもらう

3. **iOSを最新バージョンにアップデート:**
   - 設定 → 一般 → ソフトウェアアップデート

4. **Safariをリセット:**
   - 設定 → Safari → 履歴とWebサイトデータを消去
   - ⚠️ 他のWebサイトのデータも削除されます

---

## 📚 参考情報

- **iOS PWA通知の仕様:** https://webkit.org/blog/13878/web-push-for-web-apps-on-ios-and-ipados/
- **Service Worker:** https://developer.mozilla.org/ja/docs/Web/API/Service_Worker_API
- **Notification API:** https://developer.mozilla.org/ja/docs/Web/API/Notifications_API

---

**作成日**: 2025-10-28  
**対象サイト**: https://minecraft.schale41.jp  
**対象バージョン**: v3.3.0  
**対応iOS**: 16.4以降
