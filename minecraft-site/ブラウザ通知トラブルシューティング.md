# 🔍 ブラウザ通知が届かない場合のトラブルシューティング

## ✅ サーバー側の確認（完了）

テストスクリプトで確認済み：
- ✅ WebSocket接続: 正常
- ✅ イベント作成: 正常
- ✅ 通知配信: 正常

**サーバー側は完全に動作しています！**

---

## 🔍 ブラウザ側の確認（こちらを確認してください）

### 1. ブラウザでサイトを開いているか確認

**重要**: 通知を受け取るには、ブラウザで以下のURLを開いている必要があります：

```
https://minecraft.schale41.jp
```

または

```
https://minecraft.schale41.jp/admin
```

### 2. WebSocket接続状態を確認

#### デスクトップブラウザ（Chrome/Firefox/Safari）の場合

1. **ブラウザで https://minecraft.schale41.jp を開く**

2. **F12キーを押して開発者ツールを開く**

3. **コンソールタブを開く**

4. **以下のコマンドを入力して実行:**
   ```javascript
   // WebSocket接続状態を確認
   console.log('WebSocket:', ws);
   console.log('接続状態:', ws?.readyState);
   // 0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED
   ```

5. **期待される結果:**
   ```
   WebSocket: WebSocket {url: "wss://minecraft.schale41.jp/", ...}
   接続状態: 1  ← これが1(OPEN)であれば正常
   ```

#### 接続状態の意味
- **0 (CONNECTING)**: 接続中
- **1 (OPEN)**: 接続成功 ✅
- **2 (CLOSING)**: 切断中
- **3 (CLOSED)**: 切断済み

### 3. Service Worker登録状態を確認

#### コンソールで確認

```javascript
// Service Worker登録状態を確認
navigator.serviceWorker.getRegistration().then(reg => {
    console.log('Service Worker:', reg);
});

// 通知許可状態を確認
console.log('通知許可:', Notification.permission);
// "granted" = 許可済み
// "denied" = 拒否
// "default" = 未設定
```

### 4. 通知許可状態を確認

#### デスクトップブラウザ

**Chrome:**
1. アドレスバー左側の鍵アイコンをクリック
2. 「サイトの設定」をクリック
3. 「通知」の項目を確認
4. 「許可」になっているか確認

**Firefox:**
1. アドレスバー左側の鍵アイコンをクリック
2. 「サイト別設定」→「通知」
3. 「許可」になっているか確認

**Safari:**
1. Safari → 環境設定 → Webサイト → 通知
2. minecraft.schale41.jp が「許可」になっているか確認

#### iPhone/iPad（PWA）

1. 設定アプリを開く
2. 通知 → Safari
3. 通知を許可がオンになっているか確認

---

## 🧪 ブラウザでリアルタイムテスト

### ステップ1: ブラウザを開く

以下のURLをブラウザで開いてください：
```
https://minecraft.schale41.jp
```

### ステップ2: 開発者ツールでコンソールを開く

- **Windows/Linux**: F12キー
- **Mac**: Cmd + Option + I

### ステップ3: コンソールでWebSocket状態を確認

```javascript
// 接続状態確認
console.log('WebSocket:', ws);
console.log('接続状態:', ws?.readyState === 1 ? '✅ 接続中' : '❌ 切断');

// Service Worker確認
navigator.serviceWorker.getRegistration().then(reg => {
    console.log('Service Worker:', reg ? '✅ 登録済み' : '❌ 未登録');
});

// 通知許可確認
console.log('通知許可:', 
    Notification.permission === 'granted' ? '✅ 許可済み' : 
    Notification.permission === 'denied' ? '❌ 拒否' : 
    '⚠️ 未設定'
);
```

### ステップ4: サーバー側でテストイベントを作成

別のターミナルで以下を実行：
```bash
cd /home/kbt0/webapp/minecraft-site
node quick-notification-test.js
```

### ステップ5: ブラウザで通知を確認

- **期待される動作**: 画面上部に通知バナーが表示される
- **タイトル**: 🎉 新しいイベント
- **本文**: 「通知テスト ...」が追加されました！

---

## ❌ よくある問題と解決方法

### 問題1: WebSocketが接続されていない

**症状:**
```javascript
console.log(ws?.readyState);
// undefined または 3 (CLOSED)
```

**原因:**
- ページを開いたばかりで接続中
- JavaScript読み込みエラー
- ネットワークエラー

**解決方法:**
1. ページをリロード（F5）
2. ブラウザキャッシュをクリア（Ctrl+Shift+Delete）
3. コンソールでエラーがないか確認

### 問題2: Service Workerが登録されていない

**症状:**
```javascript
navigator.serviceWorker.getRegistration();
// → Promise {<fulfilled>: undefined}
```

**原因:**
- main.jsが読み込まれていない
- HTTPSではない（localhostを除く）
- Service Workerがブロックされている

**解決方法:**
1. HTTPSでアクセスしているか確認
2. アドレスバーに鍵アイコンがあるか確認
3. main.jsが読み込まれているか確認:
   ```javascript
   console.log(typeof registerServiceWorker);
   // "function" であれば正常
   ```

### 問題3: 通知許可が「拒否」になっている

**症状:**
```javascript
console.log(Notification.permission);
// "denied"
```

**解決方法:**

**Chrome:**
1. chrome://settings/content/notifications にアクセス
2. ブロック一覧から minecraft.schale41.jp を削除
3. ページをリロード

**Firefox:**
1. about:preferences#privacy にアクセス
2. 許可設定 → 通知 → 設定
3. minecraft.schale41.jp を削除
4. ページをリロード

**Safari:**
1. Safari → 環境設定 → Webサイト → 通知
2. minecraft.schale41.jp を削除
3. ページをリロード

### 問題4: コンソールにエラーが表示される

**よくあるエラー:**

```javascript
// WebSocketエラー
WebSocket connection to 'wss://...' failed
```
**解決方法**: サーバーが起動しているか確認

```javascript
// Service Workerエラー
Failed to register a ServiceWorker
```
**解決方法**: HTTPSでアクセスしているか確認

```javascript
// 通知エラー
Notification permission denied
```
**解決方法**: 通知許可を「許可」に変更

---

## 🎯 完全動作確認チェックリスト

ブラウザのコンソールで以下を確認してください：

```javascript
// === 完全動作確認スクリプト ===

console.log('🔍 通知システム診断開始\n');

// 1. WebSocket接続
const wsState = ws?.readyState;
console.log('1️⃣ WebSocket:', 
    wsState === 1 ? '✅ 接続中' : 
    wsState === 0 ? '⏳ 接続中...' : 
    '❌ 切断 (ページをリロードしてください)'
);

// 2. Service Worker
navigator.serviceWorker.getRegistration().then(reg => {
    console.log('2️⃣ Service Worker:', 
        reg ? '✅ 登録済み' : '❌ 未登録 (ページをリロードしてください)'
    );
});

// 3. 通知許可
console.log('3️⃣ 通知許可:', 
    Notification.permission === 'granted' ? '✅ 許可済み' : 
    Notification.permission === 'denied' ? '❌ 拒否 (ブラウザ設定で許可してください)' : 
    '⚠️ 未設定 (通知許可をリクエストしてください)'
);

// 4. HTTPS
console.log('4️⃣ HTTPS:', 
    location.protocol === 'https:' ? '✅ セキュア' : '❌ HTTPでは通知が動作しません'
);

console.log('\n📝 診断完了');
console.log('すべて ✅ であれば通知が届くはずです！');
```

---

## 🚀 テストイベントを今すぐ作成

サーバー側でテストイベントを作成します：

```bash
cd /home/kbt0/webapp/minecraft-site
node quick-notification-test.js
```

実行後、ブラウザで通知が表示されるか確認してください！

---

## 📱 iPhoneの場合

iPhoneでは、**必ずPWAとしてインストール**してください。

### インストール手順

1. Safariで https://minecraft.schale41.jp を開く
2. 画面下部の「共有」ボタン（□に↑）をタップ
3. 「ホーム画面に追加」をタップ
4. ホーム画面の「Bedrock」アイコンをタップして起動
5. 通知許可のポップアップで「許可」をタップ

詳細は `IOS-SETUP-GUIDE.md` を参照してください。

---

## 💡 まとめ

### サーバー側: ✅ 完全に動作中
- WebSocket配信: 正常
- イベント作成: 正常
- 通知送信: 正常

### ブラウザ側: 確認が必要
以下をすべて確認してください：
- [ ] ブラウザで https://minecraft.schale41.jp を開いている
- [ ] WebSocket接続状態が 1 (OPEN)
- [ ] Service Workerが登録済み
- [ ] 通知許可が「許可」になっている
- [ ] HTTPSでアクセスしている

すべて ✅ であれば、通知が正常に届きます！

---

**次のアクション:**

1. ブラウザで https://minecraft.schale41.jp を開く
2. F12でコンソールを開く
3. 上記の診断スクリプトを実行
4. サーバー側で `node quick-notification-test.js` を実行
5. ブラウザで通知を確認！

試してみてください！ 🚀
